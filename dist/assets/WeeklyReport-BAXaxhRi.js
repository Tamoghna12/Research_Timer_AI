import{T as $,g as B,c as L,m as z,r as D,u as U,j as e,B as j,C as v,a as w,b as R}from"./index-Dl1i7N7L.js";import{u as q}from"./useSettings-4Dc8jXWI.js";import{l as K,g as I,f as Y,h as C,e as Q,d as V,c as X,b as Z,s as ee,t as te}from"./analytics-Cc-YzX2n.js";function ae(n,r){const o=r?.weekStartsOn,i=K(n,r?.in),d=i.getDay(),c=(d<o?-7:0)+6-(d-o);return i.setDate(i.getDate()+c),i.setHours(23,59,59,999),i}function F(n,r,o){return I(n,-1,o)}function J(n){const r=Y(n,{weekStartsOn:1}),o=ae(n,{weekStartsOn:1});return o.setHours(23,59,59,999),{start:r,end:o}}function _(n,r){const o=C(n,"EEE dd MMM yyyy"),i=C(r,"EEE dd MMM yyyy");return`${o} – ${i}`}function W(){return J(new Date)}function re(n){return n.split(`
`).map(r=>r.trim()).filter(r=>r.length>0).slice(0,5)}function ne(n){if(!n.journal)return[];const r=[];switch(n.journal.kind){case"lit":n.journal.keyClaim&&r.push(`**Key Claim:** ${n.journal.keyClaim}`),n.journal.method&&r.push(`**Method:** ${n.journal.method}`),n.journal.limitation&&r.push(`**Limitation:** ${n.journal.limitation}`);break;case"writing":n.journal.wordsAdded!==null&&n.journal.wordsAdded!==void 0&&r.push(`**Words Added:** ${n.journal.wordsAdded}`),n.journal.sectionsTouched&&r.push(`**Sections:** ${n.journal.sectionsTouched}`);break;case"analysis":n.journal.nextStep&&r.push(`**Next Step:** ${n.journal.nextStep}`),n.journal.scriptOrNotebook&&r.push(`**Script:** ${n.journal.scriptOrNotebook}`),n.journal.datasetRef&&r.push(`**Dataset:** ${n.journal.datasetRef}`);break;case"deep":case"break":n.journal.whatMoved&&r.push(`**Progress:** ${n.journal.whatMoved}`);break}return r.slice(0,5)}function se(n){return n?n.split(`
`).filter(i=>i.trim().length>0).slice(0,3).map(i=>{const d=i.trim();return d.length>200?`${d.substring(0,197)}...`:d}):[]}function le(n){const r=n.filter(o=>o.status==="completed"&&(o.links&&o.links.length>0||o.link&&o.link.length>0));return r.sort((o,i)=>{const d=c=>{let a=0;c.aiSummary?a+=1e3:c.journal?a+=100:c.notes&&(a+=10);const k=c.endedAt?c.endedAt-c.startedAt:0;return a+=Math.min(k/6e4,90),a};return d(i)-d(o)}),r.slice(0,3)}function ie(n){const r=[];return n.forEach(i=>{if(i.journal?.kind==="analysis"&&i.journal.nextStep&&r.push(i.journal.nextStep),i.notes){const d=i.notes.match(/TODO:\s*(.+)/gi);d&&d.forEach(c=>{const a=c.replace(/TODO:\s*/i,"").trim();a&&r.push(a)})}}),[...new Set(r)].slice(0,10).map(i=>i.length>150?`${i.substring(0,147)}...`:i)}function E(n){return n.replace(/\|/g,"\\|").replace(/`/g,"\\`").replace(/\n/g," ").trim()}function P(n){const r=Math.floor(n/60),o=n%60;return r===0?`${o}m`:o===0?`${r}h`:`${r}h ${o}m`}function H(n){const{sessions:r,start:o,end:i,analytics:d,researcher:c}=n,a=[];if(a.push("# Weekly Report"),a.push(""),a.push(`**Week:** ${_(o,i)}`),a.push(""),c?.name||c?.affiliation){const s=[c.name,c.affiliation].filter(Boolean).join(", ");a.push(`**Researcher:** ${s}`),a.push("")}a.push("## Summary"),a.push(""),a.push(`- **Total Focus Time:** ${P(d.totalFocusTimeMin)}`),a.push(`- **Sessions Completed:** ${d.sessionsCompleted}`),a.push(`- **Average Session Length:** ${d.avgSessionLengthMin.toFixed(1)} minutes`),a.push(`- **Completion Rate:** ${d.completionRatePct}%`),a.push(""),a.push("## Time Distribution"),a.push(""),Object.keys(d.modeDist).length>0&&(a.push("### By Mode"),a.push(""),Object.entries(d.modeDist).sort((s,p)=>p[1]-s[1]).forEach(([s,p])=>{const b=$.find(N=>N.id===s)?.name||s;a.push(`- **${b}:** ${P(p)}`)}),a.push("")),Object.keys(d.tagDist).length>0&&(a.push("### Top Focus Areas"),a.push(""),Object.entries(d.tagDist).sort((s,p)=>p[1]-s[1]).forEach(([s,p])=>{a.push(`- **${s}:** ${P(p)}`)}),d.tagOtherMin>0&&a.push(`- **Other:** ${P(d.tagOtherMin)}`),a.push(""));const k=le(r);k.length>0&&(a.push("## Highlights"),a.push(""),k.forEach(s=>{const S=$.find(g=>g.id===s.mode)?.name||s.mode,b=s.links&&s.links.length>0?B(s.links[0]):s.link?L(s.link):"",N=C(new Date(s.startedAt),"MMM dd");a.push(`### ${S} - ${N}${b?` (${b})`:""}`),a.push(""),s.goal&&(a.push(`**Goal:** ${s.goal}`),a.push(""));let y=[],M=!1;s.aiSummary?(y=re(s.aiSummary),M=!0):s.journal?y=ne(s):s.notes&&(y=se(s.notes)),y.length>0&&(y.forEach(g=>{const A=g.startsWith("•")||g.startsWith("-")?g:`• ${g}`;a.push(A)}),M&&(a.push(""),a.push("*AI-assisted summary*"))),a.push("")})),a.push("## Session Log (Appendix)"),a.push("");const u=r.filter(s=>s.status==="completed").sort((s,p)=>p.startedAt-s.startedAt);u.length>0?(a.push("| Date | Mode | Goal | Tags | Links | Duration | Journal |"),a.push("|------|------|------|------|-------|----------|---------|"),u.forEach(s=>{const S=$.find(t=>t.id===s.mode)?.name||s.mode,b=C(new Date(s.startedAt),"MMM dd"),N=s.endedAt?z(s.endedAt-s.startedAt):0,y=E(s.goal||"-"),M=E(s.tags.join(", ")||"-"),g=s.links&&s.links.length>0?E(s.links.map(t=>B(t)).join(", ")):s.link?E(L(s.link)):"-",A=s.journal?s.aiSummary?"AI+Journal":"Journal":s.aiSummary?"AI":"-";a.push(`| ${b} | ${S} | ${y} | ${M} | ${g} | ${N}m | ${A} |`)})):a.push("*No completed sessions this week.*"),a.push("");const T=ie(r);return a.push("## Next Week Plan"),a.push(""),T.length>0?T.forEach(s=>{a.push(`- [ ] ${s}`)}):(a.push("*No specific plans identified from this week's sessions.*"),a.push(""),a.push("Consider adding TODO items in your session notes or next steps in analysis journals.")),a.push(""),a.push("---"),a.push("*Generated by Research Timer Pro*"),a.join(`
`)}async function oe(n){if(navigator.clipboard&&window.isSecureContext)try{return await navigator.clipboard.writeText(n),!0}catch(r){console.warn("Clipboard API failed, falling back to execCommand",r)}try{const r=document.createElement("textarea");r.value=n,r.style.position="fixed",r.style.left="-999999px",r.style.top="-999999px",document.body.appendChild(r),r.focus(),r.select();const o=document.execCommand("copy");return document.body.removeChild(r),o}catch(r){return console.error("Fallback clipboard copy failed",r),!1}}function ce(n,r,o="text/plain"){try{const i=new Blob([r],{type:o}),d=URL.createObjectURL(i),c=document.createElement("a");c.href=d,c.download=n,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(d)}catch(i){throw console.error("Download failed",i),new Error("Failed to download file")}}function de(n,r="md"){const o=n.getFullYear(),i=String(n.getMonth()+1).padStart(2,"0"),d=String(n.getDate()).padStart(2,"0");return`weekly-report-${o}-${i}-${d}.${r}`}function me(){window.print()}const pe=()=>{const[n,r]=D.useState(()=>W().start),[o,i]=D.useState("idle"),{settings:d}=q(),c=D.useMemo(()=>{const{start:t,end:l}=J(n);return{start:t,end:l,display:_(t,l)}},[n]),{sessions:a,loading:k}=U({dateRange:{from:c.start,to:c.end}}),u=D.useMemo(()=>{const t={start:c.start,end:c.end},[l,m]=Q(a,t,10);return{totalFocusTimeMin:te(a,t),sessionsCompleted:ee(a,t),avgSessionLengthMin:Z(a,t),completionRatePct:X(a,t),modeDist:V(a,t),tagDist:l,tagOtherMin:m}},[a,c]),T=D.useMemo(()=>{const t=a.filter(l=>l.status==="completed"&&l.link&&l.link.length>0);return t.sort((l,m)=>{const x=h=>{let f=0;h.aiSummary?f+=1e3:h.journal?f+=100:h.notes&&(f+=10);const O=h.endedAt?h.endedAt-h.startedAt:0;return f+=Math.min(O/6e4,90),f};return x(m)-x(l)}),t.slice(0,3)},[a]),s=()=>{r(t=>F(t))},p=()=>{r(t=>I(t,1))},S=()=>{r(W().start)},b=()=>{r(F(W().start))},N=async()=>{i("copying");try{const t=H({sessions:a,start:c.start,end:c.end,analytics:u,researcher:d?.researcher}),l=await oe(t);i(l?"success":"error"),setTimeout(()=>i("idle"),3e3)}catch(t){console.error("Copy failed:",t),i("error"),setTimeout(()=>i("idle"),3e3)}},y=()=>{try{const t=H({sessions:a,start:c.start,end:c.end,analytics:u,researcher:d?.researcher}),l=de(c.start,"md");ce(l,t,"text/markdown")}catch(t){console.error("Download failed:",t)}},M=()=>{me()},g=t=>{const l=Math.floor(t/60),m=t%60;return l===0?`${m}m`:m===0?`${l}h`:`${l}h ${m}m`},A=t=>{if(t.aiSummary)return t.aiSummary.split(`
`).filter(l=>l.trim().length>0).slice(0,5);if(t.journal){const l=[];switch(t.journal.kind){case"lit":t.journal.keyClaim&&l.push(`Key Claim: ${t.journal.keyClaim}`),t.journal.method&&l.push(`Method: ${t.journal.method}`),t.journal.limitation&&l.push(`Limitation: ${t.journal.limitation}`);break;case"writing":t.journal.wordsAdded&&l.push(`Words Added: ${t.journal.wordsAdded}`),t.journal.sectionsTouched&&l.push(`Sections: ${t.journal.sectionsTouched}`);break;case"analysis":t.journal.nextStep&&l.push(`Next Step: ${t.journal.nextStep}`),t.journal.scriptOrNotebook&&l.push(`Script: ${t.journal.scriptOrNotebook}`);break;case"deep":case"break":t.journal.whatMoved&&l.push(`Progress: ${t.journal.whatMoved}`);break}return l}return t.notes?t.notes.split(`
`).filter(l=>l.trim().length>0).slice(0,3):[]};return e.jsxs("div",{className:"transition-all duration-300",role:"document",children:[e.jsxs("div",{className:"text-center space-y-4 p-6 pb-8",children:[e.jsx("h1",{className:"font-display text-4xl lg:text-5xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent drop-shadow-lg",children:"Weekly Report"}),e.jsx("p",{className:"text-lg text-gray-600 dark:text-gray-400",children:c.display})]}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between bg-white/70 dark:bg-gray-900/70 backdrop-blur-lg rounded-xl p-4 border border-gray-200/30 dark:border-gray-700/30",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(j,{variant:"ghost",size:"sm",leftIcon:"chevron_left",onClick:()=>r(F(n)),children:"Previous"}),e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>r(W().start),children:"This Week"}),e.jsx(j,{variant:"ghost",size:"sm",rightIcon:"chevron_right",onClick:()=>r(I(n,1)),children:"Next"})]}),e.jsxs("div",{className:"flex gap-2 mt-4 sm:mt-0 no-print",children:[e.jsx(j,{variant:"ghost",leftIcon:"content_copy",onClick:N,disabled:k||o==="copying","aria-label":"Copy report as Markdown to clipboard",children:o==="copying"?"Copying...":o==="success"?"Copied!":o==="error"?"Failed":"Copy Markdown"}),e.jsx(j,{variant:"secondary",leftIcon:"download",onClick:y,disabled:k,"aria-label":"Download report as Markdown file",children:"Download .md"}),e.jsx(j,{variant:"secondary",leftIcon:"print",onClick:M,"aria-label":"Print report to PDF",children:"Print"})]})]}),e.jsx(v,{className:"no-print",children:e.jsx(w,{className:"py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"ghost",size:"sm",leftIcon:"chevron_left",onClick:s,"aria-label":"Previous week",children:"Previous"}),e.jsx(j,{variant:"ghost",size:"sm",leftIcon:"chevron_right",onClick:p,"aria-label":"Next week",children:"Next"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(j,{variant:"secondary",size:"sm",onClick:S,children:"This Week"}),e.jsx(j,{variant:"secondary",size:"sm",onClick:b,children:"Last Week"})]})]})})}),k?e.jsx(v,{children:e.jsx(w,{className:"py-8 text-center",children:e.jsx("div",{className:"text-gray-500 dark:text-gray-400",children:"Loading report data..."})})}):e.jsxs(e.Fragment,{children:[e.jsxs(v,{children:[e.jsx(R,{children:e.jsx("h2",{className:"font-display text-xl font-medium",children:"Summary"})}),e.jsx(w,{children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-semibold text-blue-600",children:g(u.totalFocusTimeMin)}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Total Focus Time"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-semibold text-blue-600",children:u.sessionsCompleted}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Sessions Completed"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-semibold text-blue-600",children:[u.avgSessionLengthMin.toFixed(1),"m"]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Avg Session Length"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-semibold text-blue-600",children:[u.completionRatePct,"%"]}),e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400",children:"Completion Rate"})]})]})})]}),e.jsxs(v,{children:[e.jsx(R,{children:e.jsx("h2",{className:"font-display text-xl font-medium",children:"Time Distribution"})}),e.jsxs(w,{className:"space-y-6",children:[Object.keys(u.modeDist).length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-700 dark:text-gray-300 mb-3",children:"By Mode"}),e.jsx("div",{className:"space-y-2",children:Object.entries(u.modeDist).sort((t,l)=>l[1]-t[1]).map(([t,l])=>{const x=$.find(h=>h.id===t)?.name||t;return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:x}),e.jsx("span",{className:"text-sm font-mono",children:g(l)})]},t)})})]}),Object.keys(u.tagDist).length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"font-medium text-gray-700 dark:text-gray-300 mb-3",children:"Top Focus Areas"}),e.jsxs("div",{className:"space-y-2",children:[Object.entries(u.tagDist).sort((t,l)=>l[1]-t[1]).map(([t,l])=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",children:t}),e.jsx("span",{className:"text-sm font-mono",children:g(l)})]},t)),u.tagOtherMin>0&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Other"}),e.jsx("span",{className:"text-sm font-mono",children:g(u.tagOtherMin)})]})]})]})]})]}),T.length>0&&e.jsxs(v,{children:[e.jsx(R,{children:e.jsx("h2",{className:"font-display text-xl font-medium",children:"Highlights"})}),e.jsx(w,{children:e.jsx("div",{className:"space-y-6",children:T.map(t=>{const m=$.find(O=>O.id===t.mode)?.name||t.mode,x=t.link?L(t.link):"",h=A(t),f=!!t.aiSummary;return e.jsxs("div",{className:"border-l-4 border-blue-600 pl-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsxs("h3",{className:"font-medium",children:[m," - ",C(new Date(t.startedAt),"MMM dd")]}),x&&e.jsx("span",{className:"text-sm px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded",children:x}),f&&e.jsx("span",{className:"text-xs px-2 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded",children:"AI"})]}),t.goal&&e.jsx("div",{className:"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:t.goal}),h.length>0&&e.jsx("div",{className:"text-sm text-gray-600 dark:text-gray-400 space-y-1",children:h.map((O,G)=>e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-600 mt-1",children:"•"}),e.jsx("span",{children:O})]},G))})]},t.id)})})})]}),e.jsxs(v,{children:[e.jsx(R,{children:e.jsx("h2",{className:"font-display text-xl font-medium",children:"Session Log (Appendix)"})}),e.jsx(w,{children:a.filter(t=>t.status==="completed").length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-300 dark:border-gray-600",children:[e.jsx("th",{className:"text-left py-2 font-medium text-gray-700 dark:text-gray-300",children:"Date"}),e.jsx("th",{className:"text-left py-2 font-medium text-gray-700 dark:text-gray-300",children:"Mode"}),e.jsx("th",{className:"text-left py-2 font-medium text-gray-700 dark:text-gray-300",children:"Goal"}),e.jsx("th",{className:"text-left py-2 font-medium text-gray-700 dark:text-gray-300",children:"Tags"}),e.jsx("th",{className:"text-left py-2 font-medium text-gray-700 dark:text-gray-300",children:"Links"}),e.jsx("th",{className:"text-right py-2 font-medium text-gray-700 dark:text-gray-300",children:"Duration"}),e.jsx("th",{className:"text-center py-2 font-medium text-gray-700 dark:text-gray-300",children:"Journal"})]})}),e.jsx("tbody",{children:a.filter(t=>t.status==="completed").sort((t,l)=>l.startedAt-t.startedAt).map(t=>{const m=$.find(f=>f.id===t.mode)?.name||t.mode,x=t.endedAt?z(t.endedAt-t.startedAt):0,h=t.journal?t.aiSummary?"AI+Journal":"Journal":t.aiSummary?"AI":"-";return e.jsxs("tr",{className:"border-b border-gray-100 dark:border-gray-800",children:[e.jsx("td",{className:"py-2 text-gray-600 dark:text-gray-400",children:C(new Date(t.startedAt),"MMM dd")}),e.jsx("td",{className:"py-2",children:m}),e.jsx("td",{className:"py-2 max-w-xs truncate",children:t.goal||"-"}),e.jsx("td",{className:"py-2 max-w-xs truncate",children:t.tags.join(", ")||"-"}),e.jsx("td",{className:"py-2 max-w-xs truncate",children:t.link?L(t.link):"-"}),e.jsxs("td",{className:"py-2 text-right font-mono",children:[x,"m"]}),e.jsx("td",{className:"py-2 text-center text-xs",children:h})]},t.id)})})]})}):e.jsx("div",{className:"text-center py-8 text-gray-500 dark:text-gray-400",children:"No completed sessions this week."})})]}),e.jsxs(v,{children:[e.jsx(R,{children:e.jsx("h2",{className:"font-display text-xl font-medium",children:"Next Week Plan"})}),e.jsx(w,{children:(()=>{const t=[];a.forEach(m=>{if(m.journal?.kind==="analysis"&&m.journal.nextStep&&t.push(m.journal.nextStep),m.notes){const x=m.notes.match(/TODO:\s*(.+)/gi);x&&x.forEach(h=>{const f=h.replace(/TODO:\s*/i,"").trim();f&&t.push(f)})}});const l=[...new Set(t)].slice(0,10);return l.length>0?e.jsx("div",{className:"space-y-2",children:l.map((m,x)=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("input",{type:"checkbox",className:"mt-1",disabled:!0,"aria-label":`Plan item: ${m}`}),e.jsx("span",{className:"text-sm",children:m})]},x))}):e.jsxs("div",{className:"text-center py-4 text-gray-500 dark:text-gray-400",children:[e.jsx("p",{children:"No specific plans identified from this week's sessions."}),e.jsx("p",{className:"text-xs mt-2",children:"Add TODO items in session notes or next steps in analysis journals."})]})})()})]})]})]})]})};export{pe as default};
